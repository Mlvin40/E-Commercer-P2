<div class="d-flex gap-2 align-items-end mb-3">
  <div>
    <label class="form-label">CategorÃ­a</label>
    <select class="form-select" [(ngModel)]="categoria" (change)="buscar()">
      <option value="">Todas</option>
      <option *ngFor="let c of categorias" [value]="c">{{ c }}</option>
    </select>
  </div>
  <div class="flex-grow-1">
    <label class="form-label">BÃºsqueda</label>
    <input class="form-control" [(ngModel)]="q" (keyup.enter)="buscar()" placeholder="Nombre del producto">
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-primary" (click)="buscar()">Filtrar</button>
    <button class="btn btn-outline-secondary" (click)="clearFiltros()">Limpiar</button>
  </div>
</div>

<div *ngIf="cargando">Cargandoâ€¦</div>
<div *ngIf="error" class="text-danger">{{ error }}</div>

<div class="row g-3" *ngIf="!cargando">
  <div class="col-12 col-sm-6 col-lg-4" *ngFor="let p of items">
    <div class="card h-100">
      <img *ngIf="p.imagenUrl" [src]="p.imagenUrl" class="card-img-top" style="height:180px;object-fit:cover">
      <div class="card-body">
        <h6 class="card-title mb-1">{{ p.nombre }}</h6>

        <!-- rating resumen -->
        <div class="small mb-1" *ngIf="p.ratingsCount > 0" title="{{ p.avgRating | number:'1.1-1' }} / 5 ({{ p.ratingsCount }})">
          <span class="me-2">{{ starsLine(p.avgRating) }}</span>
          <span class="text-muted">
            {{ p.avgRating | number:'1.1-1' }} ({{ p.ratingsCount }})
          </span>
        </div>
        <div class="small text-muted mb-1" *ngIf="p.ratingsCount === 0">Sin calificaciones</div>

        <div class="text-muted small mb-1">{{ p.categoria }} Â· Stock: {{ p.stock }}</div>
        <div class="fw-bold mb-2">Q {{ p.precio | number:'1.2-2' }}</div>

        <div class="small text-secondary mb-2" *ngIf="p.vendedorNombre">
          por {{ p.vendedorNombre }}
          <span class="ms-1" *ngIf="p.vendedorCorreo" [title]="p.vendedorCorreo">ðŸ“§</span>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-primary" (click)="addToCart(p.id)">Agregar al carrito</button>
          <button class="btn btn-sm btn-outline-secondary" (click)="toggleComentarios(p.id)">
            {{ expandedComments[p.id] ? 'Ocultar' : 'Ver' }} comentarios
          </button>
        </div>

        <!-- panel de comentarios -->
        <div class="mt-2" *ngIf="expandedComments[p.id]">
          <div *ngIf="cargandoComentarios[p.id]" class="text-muted small">Cargando comentariosâ€¦</div>
          <div *ngIf="!cargandoComentarios[p.id] && (comentarios[p.id]?.length || 0) === 0" class="text-muted small">
            Sin comentarios.
          </div>
          <div class="list-group list-group-flush small" *ngIf="comentarios[p.id]?.length">
            <div class="list-group-item" *ngFor="let c of comentarios[p.id] | slice:0:3">
              <div class="d-flex justify-content-between">
                <strong>{{ c.usuario }}</strong>
                <span title="{{ c.estrellas }} / 5">{{ 'â˜…'.repeat(c.estrellas) + 'â˜†'.repeat(5-c.estrellas) }}</span>
              </div>
              <div class="text-muted">{{ c.fecha | date:'short' }}</div>
              <div>{{ c.comentario }}</div>
            </div>
            <div class="text-end mt-1" *ngIf="(comentarios[p.id]?.length || 0) > 3">
              <span class="text-muted">Mostrando 3 de {{ comentarios[p.id]?.length }}</span>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<nav class="mt-3" *ngIf="totalPages > 1">
  <ul class="pagination">
    <li class="page-item" [class.disabled]="page===0">
      <button class="page-link" (click)="load(page-1)">Â«</button>
    </li>
    <li class="page-item" *ngFor="let i of pages" [class.active]="i===page">
      <button class="page-link" (click)="load(i)">{{ i + 1 }}</button>
    </li>
    <li class="page-item" [class.disabled]="page===totalPages-1">
      <button class="page-link" (click)="load(page+1)">Â»</button>
    </li>
  </ul>
</nav>
